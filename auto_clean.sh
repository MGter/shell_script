#!/bin/bash

# =============================================================================
# ğŸ“ è‡ªåŠ¨æ¸…ç†è„šæœ¬ï¼šå½“æ–‡ä»¶æ•° > 20 æ—¶ï¼Œåˆ é™¤æœ€æ—§çš„æ–‡ä»¶
# ğŸ” æ¯ 5 ç§’æ‰§è¡Œä¸€æ¬¡
# ğŸ“ å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼ˆéå­ç›®å½•ï¼‰
# ğŸ’¡ å®‰å…¨è®¾è®¡ï¼šæ”¯æŒéšè—æ–‡ä»¶æ’é™¤ã€æ—¥å¿—è¾“å‡ºã€é˜²è¯¯åˆ 
# =============================================================================

# é…ç½®å‚æ•°
MAX_FILES=20           # è¶…è¿‡æ­¤æ•°é‡å°±åˆ é™¤æœ€æ—§çš„
CHECK_INTERVAL=5      # æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
LOG_FILE="./clean.log" # æ—¥å¿—æ–‡ä»¶è·¯å¾„
IGNORE_PATTERNS=".git .DS_Store .swp *.tmp"  # å¿½ç•¥çš„æ–‡ä»¶/æ¨¡å¼

# è®°å½•æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# è·å–å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼ˆä¸å«å­ç›®å½•ï¼‰ï¼Œå¹¶è¿‡æ»¤æ‰å¿½ç•¥é¡¹
get_files() {
    local files=()
    # æ‰¾å‡ºæ‰€æœ‰æ™®é€šæ–‡ä»¶ï¼ˆä¸é€’å½’ï¼‰ï¼Œå¹¶æ’é™¤æŒ‡å®šæ¨¡å¼
    for file in *; do
        # è·³è¿‡ç›®å½•
        [[ -d "$file" ]] && continue
        # è·³è¿‡å¿½ç•¥çš„æ–‡ä»¶
        for pattern in $IGNORE_PATTERNS; do
            [[ "$file" == $pattern ]] && continue 2
        done
        # ä¿ç•™æ–‡ä»¶å
        files+=("$file")
    done
    # è¿”å›æ•°ç»„é•¿åº¦å’Œæ–‡ä»¶åˆ—è¡¨
    echo "${#files[@]}"
    printf '%s\n' "${files[@]}"
}

# ä¸»é€»è¾‘
main() {
    log "âœ… å¯åŠ¨è‡ªåŠ¨æ¸…ç†æœåŠ¡ï¼Œæœ€å¤§æ–‡ä»¶æ•°: $MAX_FILES"

    while true; do
        # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
        count=$(get_files | head -n1)
        files=$(get_files | tail -n+2)

        # åˆ¤æ–­æ˜¯å¦éœ€è¦æ¸…ç†
        if (( count > MAX_FILES )); then
            # æŒ‰ä¿®æ”¹æ—¶é—´å‡åºæ’åˆ—ï¼Œå–ç¬¬ä¸€ä¸ªï¼ˆæœ€æ—§ï¼‰
            oldest_file=$(echo "$files" | sort -r -t. -k1,1 -k2,2 -k3,3 | tail -n1)

            if [[ -n "$oldest_file" ]]; then
                log "âš ï¸ è¶…è¿‡ $MAX_FILES ä¸ªæ–‡ä»¶ï¼ˆå…± $count ä¸ªï¼‰ï¼Œåˆ é™¤æœ€æ—§æ–‡ä»¶ï¼š$oldest_file"
                rm -f "$oldest_file"
                log "ğŸ—‘ï¸ å·²åˆ é™¤ï¼š$oldest_file"
            else
                log "âŒ æœªæ‰¾åˆ°å¯åˆ é™¤çš„æ–‡ä»¶ï¼ˆå¯èƒ½å…¨éƒ¨è¢«å¿½ç•¥æˆ–ä¸ºç©ºï¼‰"
            fi
        else
            log "âœ… æ–‡ä»¶æ•°é‡ $count â‰¤ $MAX_FILESï¼Œæ— éœ€æ¸…ç†ã€‚"
        fi

        # ç­‰å¾…ä¸‹ä¸€è½®
        sleep "$CHECK_INTERVAL"
    done
}

# å¯åŠ¨ä¸»ç¨‹åº
main
